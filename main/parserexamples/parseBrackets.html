<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
    <title>keybased-tree - Search Brackets</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='./css/keybasedTree.css'>
    <link rel="icon" href="./favicon.ico">
    <script src='build/keybased-tree-bundle.js'></script>
    <script>
        //iife
        (function () {
            // console.log('version (from package.json) ', bridge.version);
            // iife, no global vars
            var tree, mode, latex, mouseClicked = false;
            // var clickWait = bridge.waitforClickModule; //bridge access via keybased-tree-bundle.js
            document.addEventListener("DOMContentLoaded", function () {
                console.log("DOM is loaded");
                document.querySelector('#versioninfo').innerHTML = bridge.version;
                var testArray = bridge.createTexStrings();
                var temp = document.querySelector('#latexId').innerHTML;
                for (var i = 0; i < testArray.length; i++) {
                    temp += '<option value="';
                    temp += testArray[i];
                    temp += '">';
                    temp += testArray[i];
                    temp += '</option>"';
                }
                document.querySelector('#latexId').innerHTML = temp;

                // use of addEventListener forced by iife pattern: onClick/onChange sucks
                // document.getElementById('nextStepButton').addEventListener('click', nextStepHandler);
                // clickWait.setButtonId('nextStepButton');
                document.getElementById('single').addEventListener('change', handleSelect);
                document.getElementById('all').addEventListener('change', handleSelect);
                document.getElementById('tree').addEventListener('change', handleSelect);
                document.getElementById('latexId').addEventListener('change', handleSelect);
                // use default selection
                handleSelect();

                function handleSelect() {
                    console.clear();
                    // console.log('handleSelect');
                    var RadioButtons = document.getElementsByName('single_or_all');
                    for (var i = 0; i < RadioButtons.length; i++) {
                        var button = RadioButtons[i];
                        if (button.checked) {
                            mode = button.id;
                        };
                    }
                    // if (mode === 'single' || mode === 'all') {
                        document.getElementById('nextStepButton').classList.add('hide');
                    // } else {
                        // document.getElementById('nextStepButton').classList.remove('hide');
                    // }
                    latex = document.getElementById("latexId").value;
                    switch (mode) {
                        case 'single':
                            decomposeRoot(latex, mode);
                            break;
                        case 'all':
                            decomposeRoot(latex, mode);
                            break;
                        case 'tree':
                            decomposeTree(latex);
                            break;
                        default:
                            console.error('case error');
                    }
                }
            });

            // function nextStepHandler(ev) {
            //     console.log('step');
            //     mouseClicked = true;
            // }

            function updateTree(tree) {
                var collect = '';
                var logNodeWithDashes = function (level, currentNode) {
                    var dashes = Array(level + 1).join("--");
                    collect += dashes;
                    collect += currentNode.content;
                    if (currentNode.children.length === 0) {
                        // https://www.utf8icons.com/character/127811/leaf-fluttering-in-wind
                        // collect += '&#127811;'
                        collect += ' \u2618'; //shamrock
                    }
                    collect += '&#13;&#10;' //CRLF
                    // console.log(dashes, currentNode.content);
                };
                tree.fromRootToLeafs(logNodeWithDashes);
                document.querySelector('#outarea_root2leafs').innerHTML = collect;
            }

            async function decomposeRoot(latex, mode) {
                Message('');
                tree = bridge.createTree(latex);
                updateTree(tree);
                var rootNode = tree['root'];
                // decomposeNodeBrackets is async and returns a Promise -> continue with .then(...
                bridge.decomposeNodeBrackets(tree, rootNode, mode).then(
                    (result) => {
                        // console.log('fulfilled', result);
                        if (mode === 'all' && result === 'no left bracket') {
                            result = 'End';
                        };
                        Message(result);
                        updateTree(tree);
                    },
                    function (y) { console.log('rejected', y); }
                );
            }

            async function decomposeTree(latex) {
                tree = bridge.createTree(latex);
                // updateTree(tree);
                var node = tree['root'];
                tree.withAllLeafs(async function (level, node) {
                    console.log('+++ decomposing ', node.content);
                    bridge.decomposeNodeBrackets(tree, node, 'tree');
                    console.log('--- decomposing of', node.content, 'fulfilled');
                    // await clickWait.waitForClick();
                });
                console.log('decomposeTree: end withAllLeafs');
                updateTree(tree);
            }; //end withAllLeafs

            function Message(message) {
                var messageElement = document.getElementById('message');
                // https://www.w3schools.com/howto/howto_js_add_class.asp
                if (message === 'OK' || message === 'End') {
                    messageElement.classList.remove("error");
                } else {
                    messageElement.classList.add("error");
                }
                messageElement.innerHTML = message;
            }
        })();
    </script>
</head>

<body class="keybased-tree">
    <nav>
        <a href="./index.html">Home</a>
        <a href="./editTree.html">Edit Tree</a>
        <a href="./viewTree.html">View tree</a>
        <a href="./testWithAllLeafs.html">Test withAllLeafs</a>
        <a href="./searchBrackets.html">Search Brackets</a>
        <a class="selected">Parse Brackets</a>
        <a href="./license.html">License</a>
    </nav>
    <h1>keybased-tree<img id='logo' src='./keybasedTree_48x48.gif'></h1>
    <h2>Parse brackets</h2>
    <!-- <h2>livereload active</h2> -->
    <p>Version: <span id="versioninfo">version</span></p>
    <h3>Array of LaTeX test strings from createTexStrings(), see
        <a href="../src/js/createLatexTestStrings.js">createLatexTestStrings.js</a>
    </h3>
    <form>
        <!-- <fieldset data-role="controlgroup" data-type="horizontal"> -->
        <input type="radio" id="single" name="single_or_all" />
        <label for="single">leftmost bracket of root</label>
        <input type="radio" id="all" name="single_or_all" checked="checked" />
        <label for="all">all brackets of root</label>
        <input type="radio" id="tree" name="single_or_all" />
        <label for="tree">tree</label>
        <!-- </fieldset> -->
    </form>
    <label for="latex">Choose a LaTeX string:</label>
    <div>
        <p><select name="latex" id="latexId" onChange="handleSelect()"></select></p>
    </div>
    <hr>
    <p id="message">dummy message</p>
    <textarea id="outarea_root2leafs" cols='60'
        rows='15'>Select LaTeX string for root node&#13;&#10;Then press button.</textarea>
    <div><button type="button" id='nextStepButton'>Next Step</button></div>
    <hr>
    <div class="see_also"><a target="_blank" href="https://icons8.com/icon/bsvRLFXKXX09/branching-arrows"
            class="fdm__copy-html-content fdm__copy-html-content-link">Branching Arrows</a> favicon.ico by <a
            target="_blank" href="https://icons8.com"
            class="fdm__copy-html-content fdm__copy-html-content-link">Icons8</a></div>
</body>

</html>
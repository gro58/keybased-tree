<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> -->
    <title>keybased-tree - Search Brackets</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' type='text/css' media='screen' href='./css/keybasedTree.css'>
    <link rel="icon" href="./favicon.ico">
    <script src='build/bundle.js'></script>
    <script>
        // console.log('version (from package.json) ', bridge.version);
        var tree;
        // TODO get rid of global vars
        document.addEventListener("DOMContentLoaded", function () {
            console.log("DOM is loaded");
            document.querySelector('#versioninfo').innerHTML = bridge.version;
            // bridge.waitforClickModule.setButtonId('nextStepButton');

            var testArray = bridge.createTexStrings();
            var temp = document.querySelector('#latexId').innerHTML;
            for (var i = 0; i < testArray.length; i++) {
                temp += '<option value="';
                temp += testArray[i];
                temp += '">';
                temp += testArray[i];
                temp += '</option>"';
            }
            document.querySelector('#latexId').innerHTML = temp;
            handleSelect();
        });

        function updateTree(tree) {
            var collect = '';
            var logNodeWithDashes = function (level, currentNode) {
                var dashes = Array(level + 1).join("--");
                collect += dashes;
                collect += currentNode.content;
                if (currentNode.children.length === 0) {
                    // https://www.utf8icons.com/character/127811/leaf-fluttering-in-wind
                    // collect += '&#127811;'
                    collect += ' \u2618'; //shamrock
                }
                collect += '&#13;&#10;' //CRLF
                // console.log(dashes, currentNode.content);
            };
            tree.fromRootToLeafs(logNodeWithDashes);
            document.querySelector('#outarea_root2leafs').innerHTML = collect;
        }

        // function nextStep() {
        //     console.log('next step');
        //     var root = tree['root'];
        //     bridge.decomposeNodeBrackets(tree, root);
        //     updateTree();
        // }

        function handleSelect() {
            var latex = document.getElementById("latexId").value;
            decomposeRoot(latex);
        }

        // async function decomposeTree(latex) {
        //     await bridge.waitforClickModule.waitForClick();
        //     tree = bridge.createTree(latex);
        //     var node = tree['root'];
        //     tree.withAllLeafs(function (level, node) {
        //         // decomposeAllBrackets is async and returns a Promise -> continue with then...
        //         decomposeAllBrackets(tree, node).then((result) => {
        //             console.log('decomposeAllBrackets:', result);
        //         });
        //     });
        // }

        async function decomposeRoot(latex) {
            ErrorMessage('');
            // await bridge.waitforClickModule.waitForClick();
            tree = bridge.createTree(latex);
            updateTree(tree);
            var rootNode = tree['root'];
            // var mode = 'single'; 
            var mode = 'all'; 
            // decomposeNodeBrackets is async and returns a Promise -> continue with .then(...
            bridge.decomposeNodeBrackets(tree, rootNode, mode).then((result) => {
                console.log('decomposeNodeBrackets mode=',mode, result);
                if (mode !== 'single'){
                    if (result ==='no left bracket'){
                        result = 'OK';
                    }
                }
                if(result !== 'OK'){
                    ErrorMessage(result);
                }
                updateTree(tree);
            });
        }

        // async function decomposeAllBrackets(tree) {
        //     // var root = tree['root'];
        //     tree.withAllLeafs(async function (level, node) {
        //         var stop = false;
        //         updateTree(tree);
        //         do {
        //             // waitForClick needs init with waitforClickModule.setButtonId('...');
        //             // await bridge.waitforClickModule.waitForClick();
        //             console.log('now decomposing ', node.content);
        //             bridge.decomposeNodeBrackets(tree, node).then(
        //                 (result) => {
        //                     if (result === 'OK') {
        //                         updateTree(tree);
        //                         console.log(result);
        //                         console.log(Array(20 + 1).join("-"));
        //                     } else {
        //                         stop = true;
        //                     }
        //                 }
        //             );
        //             // } while (resultMessage === 'OK');
        //         } while (!stop);
        //     });
        //     return 'End';
        // }

        function ErrorMessage(message) {
            var errorElement = document.getElementById('errormessage');
            if (message.length > 0) {
                errorElement.innerHTML = message;
                // https://www.w3schools.com/howto/howto_js_add_class.asp
                errorElement.classList.add("active");
            } else {
                errorElement.classList.remove("active");
            }
        }
    </script>
</head>

<body class="keybased-tree">
    <nav>
        <a href="./index.html">Home</a>
        <a href="./editTree.html">Edit Tree</a>
        <a href="./viewTree.html">View tree</a>
        <a href="./testWithAllLeafs.html">Test withAllLeafs</a>
        <a href="./searchBrackets.html">Search Brackets</a>
        <a class="selected">Parse Brackets</a>
        <a href="./license.html">License</a>
    </nav>
    <h1>keybased-tree</h1>
    <h2>Parse brackets</h2>
    <!-- <h2>livereload active</h2> -->
    <p>Version: <span id="versioninfo">version</span></p>
    <h3>Array of LaTeX test strings from createTexStrings(), see
        <a href="../src/js/createLatexTestStrings.js">createLatexTestStrings.js</a>
    </h3>
    <label for="latex">Choose a LaTeX string:</label>
    <select name="latex" id="latexId" onChange="handleSelect()"></select>
    <p id="errormessage" class="active">dummy error</p>
    <textarea id="outarea_root2leafs" cols='60' rows='15'>Select LaTeX string for root node&#13;&#10;Then press button.</textarea>
    <!-- <div><button type="button" id='nextStepButton' style='display:inline-block'>Next Step</button></div> -->
    <hr>
    <div class="see_also"><a target="_blank" href="https://icons8.com/icon/bsvRLFXKXX09/branching-arrows"
            class="fdm__copy-html-content fdm__copy-html-content-link">Branching Arrows</a> favicon.ico by <a
            target="_blank" href="https://icons8.com"
            class="fdm__copy-html-content fdm__copy-html-content-link">Icons8</a></div>
</body>

</html>